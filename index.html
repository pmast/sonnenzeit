<html>
	<head>
		<style>
			.chart rect {
			  fill: steelblue;
			}

			.chart text {
			  fill: white;
			  font: 10px sans-serif;
			  text-anchor: end;
			}
			div.tooltip {   
				position: absolute;           
				text-align: left;
				width: 120px;                  
				height: 42px;                 
				padding: 2px;             
				font: 12px sans-serif;        
				background: lightsteelblue;   
				border: 0px;      
				border-radius: 8px;           
				pointer-events: none;         
			}
			#mapcontainer{position:relative;
      			width:100%;
      			height:250px;
    		}
		</style>
		
		<link href="style/bootstrap.min.css" rel="stylesheet">
		<link href="style/bootstrap-theme.min.css" rel="stylesheet">
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="js/suncalc.js"></script>
		<!--<script src="js/d3.v3.min.js"></script>-->
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>


		<script>
			// var chart;
			var tzOffset;

			function toString(sec){
				zeros = d3.format("02f");
				hours = Math.floor(sec/3600);
				minutes = Math.floor((sec-hours*3600)/60);
				seconds = sec - hours*3600 - minutes*60;
				return hours + ":" + zeros(minutes) + ":" + zeros(seconds);
			}

			function isToday(d){
				today = new Date();
				if(today.getFullYear() == d.getFullYear() && today.getDate() == d.getDate() && today.getMonth() == d.getMonth())
					return true;
				return false;
			}

			function drawGraph(){
    			

				//Amrum
				// d = getList([54.651667, 8.336389]);

				//Hamburg
				var p = {lat: 53.550556,lng:9.993333};

				// rio
				p = {lat: -22.908333,lng: -43.196389}; // getList([-22.908333, -43.196389]);
				d = getList(p);


				updateGraph(d, chart);
				window.setTimeout(function(){
					console.log('rio');
					// rio
					// d = getList([-22.908333, -43.196389]);
					updateGraph(d, chart);
				}, 1500);
			}

			function init(){


				var chart = initGraph();
				var map = initMap();

				map.on("moveend",function(e){
					var c = map.getCenter().wrap();
					var ll = []
					var now = new Date();
					updateGraph(c, 1, chart);
				});
				var p = {lng:8.336389, lat:54.651667};
				var d = new Date();


				// amrum
				var p = {lng:8.336389, lat:54.651667};

				// rio
				p = {lat: -22.908333,lng: -43.196389};

				// pitcairn
				// p = {lat: -24.362180,lng: -128.377562};

				// nuuk
				// p = {lat: 64.204170,lng: -51.278792};

				// alaska
				// p = {lat: 68.550344,lng: -66.576181};

				// var p = {lat: -22.908333, lng: -43.196389};
				updateGraph(p, 1, chart);
				return;
			}

			function initMap(){
				var map = L.map('map', {
					// maxBounds: L.latLngBounds([-90, -180], [90, 180])
				}).setView([43.5, 10], 2);
				L.tileLayer('http://maps.vesseltracker.com/vesseltracker/{z}/{x}/{y}.png', {
					attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
					maxZoom: 18,
					// noWrap: true
				}).addTo(map);
				return map;
			}

			function initGraph(){
				var chart = d3.select("#chartcontainer").append("svg")
    				.attr("class", "graph");
    			return chart;
			}

			function getTimes(d, p, offset){
				var a = SunCalc.getTimes(d, p.lat, p.lng);
				for (var property in a){
					a[property] = new Date(a[property].getTime() + offset * 60 * 1000);
				}
				return a;
			}

			function getList(p, offset){

				d = new Date();
				d.setMonth(0);
				d.setDate(1);
				d.setHours(12, 0, 0, 0);
				

				od = 0;
				var o;
				l = [];
				var oldrise = null;
				for (i=0; i<365; i++){
					d.setDate(d.getDate()+1);
					a = getTimes(d, p, offset);
					sr = a.sunrise;
					ss = a.sunset;
					noon = a.solarNoon;
					duration = ss.getTime() - sr.getTime();

					if (oldrise == null){
						delta = 0;
					} else {
						if (!isNaN(sr.getTime()) && !isNaN(oldrise)){
							delta = delta + ((sr.getTime() - oldrise)-24*3600*1000);
						} else {
							console.log(NaN);
						}
					}

					oldrise = sr.getTime();

					o = {sunrise: sr,
						sunset: ss,
						noon: noon,
						date: new Date(d),
						duration: duration,
						delta: delta,
					};
					l.push(o);
				}
				return l;
			}

			function updateGraph(p, offset, chart){
				var day_length = 24*3600;

				data = getList(p, offset);
				// console.log(p.lat);

				var max = d3.max(data, function(d) {
					return d.delta + d.duration;
				});
				var min = d3.min(data, function(d) {
					// console.log("%s, %s, %s, %s", d.delta, d.duration, d.sunrise.getTime(), d.sunset.getTime());
					return d.delta;
				});

				height = 150;
				width = 365*2;

				t = 24*1000*3600 - (max - min);

				// max = min + 24*3600;
				// x = d3.scale.linear().range([0, width]).domain([0, tdata[0].length-1]);
				y = d3.scale.linear().domain([min-t/2, max+t/2]).range([0, height]);
				// colors = d3.scale.category10();


				var div = d3.select("body").append("div")   
    				.attr("class", "tooltip")               
    				.style("opacity", 0);

    			var timeFormat = d3.time.format("%H:%M:%S");
    			var dateFormat = d3.time.format("%Y-%m-%d");

				var bar = chart.selectAll("rect")
					.data(data);

				bar.enter().append("rect")
					.attr("y", function(d){
						if (isNaN(d.sunrise.getTime()))
							return 0;
						return y(d.delta);
					})
					.attr("x", function(d, i) {
						return i*2;
					})
					.attr("width", 2)
					.attr("height", function(d, i){
						if (isNaN(d.sunset.getTime()))
							return height;
						return y(d.delta + d.duration) - y(d.delta);
					})
					.attr("fill", 'gold');

				bar.transition()
					.attr("height", function(d){
						if (isNaN(d.sunset.getTime())){
							return height;
						}
						return y(d.delta + d.duration) - y(d.delta);
					})
					.attr("y", function(d){
						if (isNaN(d.sunrise.getTime()))
							return 0;
						return y(d.delta);
						// return y(max_d/4 + d.sunrise_sec2);
					})
					.attr("x", function(d, i) {
						return i*2;
					})
					.duration(1000);

			}
		</script>
	</head>
	<body onLOad="javascript:init();" style="font-size: 20pt; font-family: Arial; background: #2b2b2b;">
		<!-- Today, daytime is <span id="today" style="color:red;">0</span> than yesterday.<br>
		<br>
		Tomorrow, daytime is <span id="tomorrow" style="color:red;">0</span> than today.<br>-->
		<br>
		<br>
		<div class="container">
			<div class="row">
								<div id="mapcontainer" class="col-md-12">
					<div style="position:absolute; width:100%; height:100%; z-index: 1; background:transparent;" id="map"></div>
						<div style="position:absolute; width:100%; height:100%; z-index: 99; pointer-events:none;">
						<svg style="width:100%; height:100%; background:transparent;">
						    <circle cx="50%" cy="50%" r="10" stroke="black" stroke-width="2" fill="transparent" />
						</svg>
					</div>
		        </div>
				<div id="chartcontainer" class="col-md-12" style="background: transparent;">
				</div>
		    </div>
		</div>
	</body>
</html>