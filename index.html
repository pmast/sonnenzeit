<html>
	<head>
		<style>
			.chart rect {
			  fill: steelblue;
			}

			.chart text {
			  fill: white;
			  font: 10px sans-serif;
			  text-anchor: end;
			}
			div.tooltip {   
				position: absolute;           
				text-align: left;
				width: 200px;                  
				height: 64px;                 
				padding: 2px;             
				font: 12px sans-serif;        
				background: #3b3b3b;   
				color: lightgray;
				border: 0px;
				border-radius:2px;
				pointer-events: none;         
			}
			#mapcontainer{position:relative;
      			width:100%;
      			height:250px;
    		}

    		div.nopad{
    			padding: 0px;
    		}

    		div.label{
    			color:lightgray;
    			font-weight:normal;
    			padding:0px;
    			font-size:10px;
    		}
		</style>
		
		<link href="style/bootstrap.min.css" rel="stylesheet">
		<link href="style/bootstrap-theme.min.css" rel="stylesheet">
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="js/suncalc.js"></script>
		<!--<script src="js/d3.v3.min.js"></script>-->
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>


		<script>
			// var chart;
			var tzOffset;
			var timeFormat = d3.time.format("%H:%M:%S");
			var dateFormat = d3.time.format("%Y-%m-%d");
			var now = new Date();


			function toString(sec){
				zeros = d3.format("02f");
				hours = Math.floor(sec/3600);
				minutes = Math.floor((sec-hours*3600)/60);
				seconds = sec - hours*3600 - minutes*60;
				return hours + ":" + zeros(minutes) + ":" + zeros(seconds);
			}

			function isToday(d){
				today = new Date();
				if(today.getFullYear() == d.getFullYear() && today.getDate() == d.getDate() && today.getMonth() == d.getMonth())
					return true;
				return false;
			}

			function init(){

				var p = {lng:8.336389, lat:54.651667};
				var d = new Date();


				// amrum
				var p = {lng:8.336389, lat:54.651667};

				// rio
				// p = {lat: -22.908333,lng: -43.196389};

				// pitcairn
				// p = {lat: -24.362180,lng: -128.377562};

				// nuuk
				// p = {lat: 64.204170,lng: -51.278792};

				// alaska
				// p = {lat: 68.550344,lng: -66.576181};

				// var p = {lat: -22.908333, lng: -43.196389};

				var chart = initGraph();
				updateGraph(p, chart);

				var map = initMap(p);
				map.on("moveend",function(e){
					var c = map.getCenter().wrap();
					updateGraph(c, chart);
				});
				return;
			}

			function initMap(p){
				var map = L.map('map', {
					// maxBounds: L.latLngBounds([-90, -180], [90, 180])
				}).setView([p.lat, p.lng], 2);
				L.tileLayer('http://maps.vesseltracker.com/vesseltracker/{z}/{x}/{y}.png', {
					attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
					maxZoom: 18,
					// noWrap: true
				}).addTo(map);
				return map;
			}

			function initGraph(){
				d3.select("body").append("div")   
    				.attr("class", "tooltip")               
    				.attr("id", "tooltip")
    				.style("opacity", 0);

				var chart = d3.select("#chartcontainer").append("svg")
    				.attr("class", "graph");

    			// chart = 
    			return chart;
			}

			function getList(p){

				var d = new Date();
				d.setMonth(0);
				d.setDate(0);
				d.setHours(12, 0, 0, 0);
				
				var year = d.getFullYear()+1;
				var data = [];
				var o;
				var today = null;
				var old_a = SunCalc.getTimes(d, p.lat, p.lng);
				var delta = 0;
				var prevDuration = old_a.sunset.getTime() - old_a.sunrise.getTime();

				d.setDate(d.getDate()+1);

				while (d.getFullYear() == year){

					a = SunCalc.getTimes(d, p.lat, p.lng);
					sr = a.sunrise;
					ss = a.sunset;
					duration = ss.getTime() - sr.getTime();

					if (!isNaN(sr.getTime()) && !isNaN(old_a.sunrise)){
						delta = delta + ((sr.getTime() - old_a.sunrise.getTime())-24*3600*1000);
					} else {
						console.log(NaN);
					}

					old_a = a;

					if (o != null){
						o.nextDuration = duration;
						if (isToday(o.date))
							today = o;
						data.push(o);
					}

					o = {sunrise: sr,
						sunset: ss,
						date: new Date(d),
						duration: duration,
						prevDuration: prevDuration,
						delta: delta,
					};
					prevDuration = duration;
					d.setDate(d.getDate()+1);
				}
				a = SunCalc.getTimes(d, p.lat, p.lng);
				o.nextDuration = a.sunset.getTime() - a.sunrise.getTime();
				data.push(o);
				return {
					today: today,
					data: data
				};
			}

			function getColor(d, i, highlight){
				highlight = highlight == null ? false : highlight;
				if (dateFormat(d.date) == dateFormat(now))
					return "red";
				if (highlight)
					return "orange";
				return "gold"
			}


			function getDurationString(ms){
				var tmp = ms/1000/60/60;

				var h = Math.floor(Math.abs(tmp));
				var min = Math.floor((Math.abs(tmp) - h)*60);
				var sec = Math.floor((Math.abs(tmp) - h - min/60)*3600);

				return ((tmp < 0) ? "-" : "") + d3.format("02d")(h) + ":" + d3.format("02d")(min) + ":" + d3.format("02d")(sec);
			}

			function getDurationString2(ms){
				var tmp = ms/1000/60/60;

				var h = Math.floor(Math.abs(tmp));
				var min = Math.floor((Math.abs(tmp) - h)*60);
				var sec = Math.floor((Math.abs(tmp) - h - min/60)*3600);

				return ((h>0) ? d3.format("d")(h) + " hours" : "") + 
					((min>0) ? " " + d3.format("d")(min) + " minutes" : "") +
					((sec>0) ? " " + d3.format("d")(sec) + " seconds" : "") + ((tmp > 0) ? " shorter" : " longer");
			}

			function updateText(d){
				var previous = "The previous day";
				var next = "The next day";
				var day = "this day";
				if (isToday(d.date)){
					day = "today";
					next = "Tomorrow";
					previous = "Yesterday";
				}

            	d3.select("#texts")
            		.html("<b>" + dateFormat(d.date) + "</b><br>"
						+ "Length of " + day + ": " + getDurationString(d.duration) + "<br>"
						+ previous + " was " + getDurationString2(d.duration - d.prevDuration) + " than " + day + ".<br>"
						+ next + " is " + getDurationString2(d.duration - d.nextDuration) + " than " + day + ".<br>"
						);

			}

			var highlight;

			function updateGraph(p, chart){
				var data = getList(p);
				var today = data.today; 
				data = data.data;

				if (highlight)
					updateText(data[highlight.i]);
				else
					updateText(today);


				var max = d3.max(data, function(d) {
					return d.delta + d.duration;
				});
				var min = d3.min(data, function(d) {
					return d.delta;
				});

				width = chart.style("width");
				width = width.substring(0, width.length-2);
				
				height = chart.style("height");
				height = height.substring(0, height.length-2);


				bar_width = width/data.length;

				t = 24*1000*3600 - (max - min);

				y = d3.scale.linear().domain([min-t/2, max+t/2]).range([0, height]);
				x = d3.scale.linear().domain([0, data.length]).range([0, width]);


				// if (highlight!=null){
				// 	d3.select(highlight.element).attr("fill", getColor(highlight.d, highlight.i));
				// }

				var bar = chart.selectAll("rect")
					.data(data);

				var old_index;

				bar.enter().append("rect")
					.attr("y", function(d){
						if (isNaN(d.sunrise.getTime()))
							return 0;
						return y(d.delta);
					})
					.attr("x", function(d, i) {
						return x(i) - .5;
					})
					.attr("width", bar_width + .5)
					.attr("height", function(d, i){
						if (isNaN(d.sunset.getTime()))
							return height;
						return y(d.delta + d.duration) - y(d.delta);
					})
					.attr("fill", function(d, i){
						return getColor(d, i);
					});

				bar.transition()
					.attr("height", function(d){
						if (isNaN(d.sunset.getTime())){
							return height;
						}
						return y(d.delta + d.duration) - y(d.delta);
					})
					.attr("y", function(d){
						if (isNaN(d.sunrise.getTime()))
							return 0;
						return y(d.delta);
						// return y(max_d/4 + d.sunrise_sec2);
					})
					.attr("x", function(d, i) {
						return x(i) - .5;
					})
					.duration(1000);
				bar.on("mouseover", function(d,i){
					d3.select(this).attr("fill", '#2b2b2b');
					// d3.select('#tooltip')
					// 	.html(dateFormat(d.date) + "<br>"
					// 		+ "Length of the day: " + getDurationString(d.duration) + "<br>"
					// 		+ "<: " +getDurationString(d.delta)+ "<br>"
					// 		+ ">: " +3+ "<br>"
					// 		)
					// 	.style("left", (d3.event.pageX + 5) + "px")     
     //            		.style("top", (d3.event.pageY - 28) + "px")
     //            		.style("opacity", 0.9);
     				if (highlight != null){
     					d3.select(highlight.element).attr("fill", getColor(highlight.d, highlight.i));
     				}
					
     				highlight = {
     					element: this,
     					d:d,
     					i:i
     				};
     				old_index = i;

     				updateText(d);
				});
				bar.on("mouseout", function(d,i){
					// console.log(i);
					d3.select(this).attr("fill", getColor(d, i, true));
					// d3.select('#tooltip')
					// 	.style("opacity", 0);
				});

			}
		</script>
	</head>
	<body onLOad="javascript:init();" style="font-size: 20pt; font-family: Arial; background: #2b2b2b;">
		<div class="container">
			<div class="row" style ="background:transparent; height:200px;">
				<div class="col-md-12 nopad" style="margin-bottom:20px;">
			        <div id="chartcontainer" style="background: transparent; height:100%">
					</div>
					<div class="label" style="position:absolute; left:0px; bottom:0px;">|&larr;January</div>
					<div class="label" style="position:absolute; right:0px; bottom:0px;">December&rarr;|</div>
				</div>
				<div id="texts" class="col-md-12 nopad" style="background: transparent; height:100; font-size:14px; color: lightgray;">
				</div>
				<div id="mapcontainer" class="col-md-12 nopad"  style="background: transparent;">
					<div style="position:absolute; width:100%; height:100%; z-index: 1; background:transparent;" id="map">
					</div>
					<div style="position:absolute; width:100%; height:100%; z-index: 99; pointer-events:none;">
						<svg style="width:100%; background:transparent;">
						    <circle cx="50%" cy="50%" r="10" stroke="black" stroke-width="2" fill="transparent" />
						</svg>
					</div>
		        </div>
		    </div>
		</div>
	</body>
</html>